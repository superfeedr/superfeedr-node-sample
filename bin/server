#!/usr/bin/env node

var express = require("express"),
    app = express.createServer(),
    io = require('socket.io').listen(app),
    superfeedr = require('superfeedr').Superfeedr; // socket.io may listen to an http

// Use Express to serve static content, such as our index.html
app.configure(function(){
  app.use(express.static(__dirname + '/../public'));
});

client = new superfeedr(process.env.SUPERFEEDR_LOGIN, process.env.SUPERFEEDR_PASSWORD);
client.on('connected', function() {
    console.log("Connected!");
    client.subscribe("http://superfeedr.com/track/music", function(err, feed) {
        console.log("Susbcribed");
    });
});

// Using long polling on heroku as they don't support websockets just yet.
io.configure(function () { 
  io.set("transports", ["xhr-polling"]); 
  io.set("polling duration", 10); 
});

//Socket.io emits this event when a connection is made.
io.sockets.on('connection', function (socket) {
  // Emit a message to send it to the client.
  client.on('notification', function(notification) {
      socket.emit('notification', notification);
  });
  
});

app.listen(process.env.PORT);

console.log('socket.io server started on port ' + process.env.PORT);
